<!-- templates/shop/cart.html -->
{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h1 class="h4 mb-3">Кошик</h1>
  {% if items %}
    <div class="list-group mb-3">
      {% for it in items %}
        <div class="list-group-item d-flex align-items-center justify-content-between flex-wrap">
          <div class="d-flex align-items-center gap-3">
            {% if it.cover %}
              <img src="{{ url_for('static', filename='img/uploads/' ~ (it.cover.preview_filename or it.cover.filename)) }}"
                   alt="" class="img-thumbnail" style="width:64px;height:64px;object-fit:cover;">
            {% endif %}
            <div>
              <div class="fw-semibold">{{ it.product.name }}</div>
              {% if it.color %}
                <div class="small text-muted">
                  Колір: <span class="badge me-1" style="background:{{ it.color.color_hex }};">&nbsp;&nbsp;</span> {{ it.color.color_name }}
                </div>
              {% endif %}
              <div class="small">Ціна: {{ "%.2f"|format(it.unit_price) }}</div>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <input type="number" min="1" value="{{ it.quantity }}" class="form-control"
                   style="width:90px" data-index="{{ it.index }}" data-action="qty-update">
            <div class="text-nowrap">Сума: {{ "%.2f"|format(it.subtotal) }}</div>
            <button class="btn btn-outline-danger btn-sm" data-index="{{ it.index }}" data-action="remove">×</button>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="d-flex justify-content-between align-items-center">
      <div class="fw-semibold">Всього: {{ "%.2f"|format(total) }}</div>
      <a class="btn btn-primary" href="{{ url_for('shop.checkout') }}">Оформити замовлення</a>
    </div>
  {% else %}
    <p>Кошик порожній.</p>
  {% endif %}
</div>
<script>
  document.querySelectorAll('[data-action="qty-update"]').forEach(el => {
    el.addEventListener('change', async (e) => {
      const index = e.target.dataset.index;
      const qty = e.target.value;
      await fetch(`/cart/update/${index}`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity: qty })
      });
      location.reload();
    });
  });
  document.querySelectorAll('[data-action="remove"]').forEach(el => {
    el.addEventListener('click', async (e) => {
      const index = e.target.dataset.index;
      await fetch(`/cart/remove/${index}`, { method: "POST" });
      location.reload();
    });
  });
</script>
{% endblock %}