{% extends "base.html" %}
{% block content %}
{% macro back_button() %}
  <div class="col-12 mt-2 d-flex justify-content-start">
    <a href="{{ url_for('admin.product_list') }}" class="btn btn-secondary">
    Повернутися до списку товарів
    </a>
  </div>
{% endmacro %}


<div class="container py-4">
  {{ back_button() }}

  <h1 class="h4 mb-4">{{ 'Створення товару' if not product else 'Редагування товару' }}</h1>

  <form method="post"
        action="{{ url_for('admin.product_edit', product_id=product.id if product else None) }}"
        enctype="multipart/form-data"
        class="row g-3">

    <!-- Поля товару -->
    <div class="col-md-4">
      <label class="form-label">SKU</label>
      <input name="sku" class="form-control" value="{{ product.sku if product else '' }}" required>
    </div>
    <div class="col-md-8">
      <label class="form-label">Назва</label>
      <input name="name" class="form-control" value="{{ product.name if product else '' }}" required>
    </div>
    <div class="col-12">
      <label class="form-label">Опис</label>
      <textarea name="description" class="form-control" rows="3">{{ product.description if product else '' }}</textarea>
    </div>
    <div class="col-md-4">
      <label class="form-label">Ціна</label>
      <input name="price" type="number" step="0.01" class="form-control" value="{{ product.price|int if product else '0' }}">
    </div>

    <!-- Додаткові характеристики -->
    <hr class="my-4">
    <h5>Характеристики свічки</h5>

    <div class="col-md-4">
      <label class="form-label">Тип воску</label>
      <input name="wax_type" class="form-control" value="{{ product.wax_type if product else '' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">Категорія</label>
      <input name="category" class="form-control" value="{{ product.category if product else '' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">Довжина (мм)</label>
      <input name="height" type="number" step="1" min="0" class="form-control" value="{{ product.height|int if product else '0' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">Ширина (мм)</label>
      <input name="width" type="number" step="1" min="0" class="form-control" value="{{ product.width|int if product else '0' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">Висота (мм)</label>
      <input name="depth" type="number" step="1" min="0" class="form-control" value="{{ product.depth|int if product else '0' }}">
    </div>

    <div class="col-md-4">
      <label class="form-label">Вага (г)</label>
      <input name="weight" type="number" step="1" min="0" class="form-control" value="{{ product.weight|int if product else '0' }}">
    </div>

    <!-- Кольори -->
    <hr class="my-4">
    <h5>Кольори</h5>
    <div id="color-fields">
      {% for color in colors %}
      <div class="row g-2 mb-2 color-row">
        <input type="hidden" name="color_id[]" value="{{ color.id }}">
        <div class="col-5">
          <input name="color_name[]" class="form-control form-control-sm" value="{{ color.color_name }}">
        </div>
        <div class="col-4">
          <input name="color_hex[]" type="color" class="form-control form-control-color w-100" value="{{ color.color_hex }}">
        </div>
        <div class="col-3">
          <button type="button" class="btn btn-sm btn-outline-danger w-100" onclick="apiDelete('color', '{{ color.id }}', this)">Видалити</button>
        </div>
      </div>
      {% endfor %}
    </div>
    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addColorRow()">+ Колір</button>

    <!-- Фотографії -->
    <hr class="my-4">
    <h5>Зображення</h5>
    <div  id="image-fields" class="row mb-3">
      {% for img in images %}
      <div class="col-6 col-md-3 mb-3 image-row">
        <div class="p-2 text-center position-relative" style="width: 120px; aspect-ratio: 1/1; margin: 0 auto;">
          <input type="hidden" name="image_id[]" value="{{ img.id }}">
          <img src="{{ url_for('static', filename='img/uploads/' + img.preview_filename) }}"
               class="img-thumbnail mb-2 w-100 h-100"
               style="aspect-ratio: 1/1; object-fit: cover; max-width: 120px; margin: 0 auto;">
          <button type="button"
                  class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle"
                  onclick="apiDelete('image', '{{ img.id }}', this)">&times;</button>
        </div>
      </div>
      {% endfor %}
    </div>
    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addImageRow()">+ Додати фото</button>



    <!-- Футер форми -->
    <div class="col-12 mt-5 p-3 bg-light d-flex flex-column align-items-start rounded">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" name="is_active" id="active"
               {% if not product or product.is_active %}checked{% endif %}>
        <label class="form-check-label" for="active">Товар активний</label>
      </div>
      {% with messages = get_flashed_messages() %}
        <button id="save-btn"
                type="submit"
                class="btn {{ 'btn-primary' if messages else 'btn-success' }}">
            {{ 'Оновлено' if messages else 'Зберегти все' }}
        </button>
        {% endwith %}

      </div>
    {{ back_button() }}
  </form>
</div>

<script>

function markDirty() {
  const saveBtn = document.getElementById("save-btn");
  if (!saveBtn) return;
  saveBtn.textContent = "Зберегти все";
  saveBtn.classList.remove("btn-primary", "btn-danger");
  saveBtn.classList.add("btn-success");
}

function addColorRow() {
  const container = document.getElementById("color-fields");
  const div = document.createElement("div");
  div.className = "row g-2 mb-2 color-row";
  div.innerHTML = `
    <input type="hidden" name="color_id[]" value="new">
    <div class="col-5"><input name="color_name[]" class="form-control form-control-sm" placeholder="Назва"></div>
    <div class="col-4"><input name="color_hex[]" type="color" class="form-control form-control-color w-100" value="#ffffff"></div>
    <div class="col-3"><button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="this.closest('.color-row').remove()">Видалити</button></div>
  `;
  container.appendChild(div);
  markDirty();
}

// Додавання рядка зображення
function addImageRow() {
  const container = document.getElementById("image-fields");
  const div = document.createElement("div");
  div.className = "col-6 col-md-3 mb-3 image-row";
  div.innerHTML = `
    <div class="card p-2 text-center shadow-sm position-relative">
      <input type="hidden" name="image_id[]" value="new">
      <img class="img-thumbnail mb-2 d-none w-100" style="aspect-ratio: 1/1; object-fit: cover; max-width: 120px; margin: 0 auto;">
      <input type="file" name="image_file[]" class="form-control form-control-sm mb-2" accept="image/*" onchange="previewImage(this)">
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="this.closest('.image-row').remove()">Скасувати</button>
    </div>
  `;
  container.appendChild(div);
  markDirty();
}

// Попередній перегляд обраного фото
function previewImage(input) {
  const file = input.files[0];
  const imgElement = input.parentElement.querySelector('img');
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      imgElement.src = e.target.result;
      imgElement.classList.remove('d-none');
    };
    reader.readAsDataURL(file);
  }
}


async function apiDelete(type, id, btn) {
  if (confirm('Видалити цей елемент?')) {
    const url = type === 'color' ? `/admin/colors/${id}/delete` : `/admin/images/${id}/delete`;
    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
      // Знаходить найближчий елемент, який має АБО клас .color-row, АБО .image-row
      const row = btn.closest('.color-row, .image-row');
      if (row) row.remove();
      markDirty();
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("form");

  form.addEventListener("input", markDirty);
  form.addEventListener("change", markDirty); // для чекбоксів, file input, color input
});

</script>
{% endblock %}
